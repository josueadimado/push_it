{% extends "brands/base_brand.html" %}
{% load static %}

{% block title %}Add Payment Method · Brand Dashboard · Push-it{% endblock %}

{% block breadcrumb %}Add Payment Method{% endblock %}

{% block brand_extra_styles %}
<style>
.add-payment-container {
    max-width: 600px;
    margin: 0 auto;
}

.card-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 32px;
}

.section-header {
    margin-bottom: 24px;
    text-align: center;
}

.section-title {
    font-size: 24px;
    font-weight: 600;
    margin: 0 0 8px 0;
    color: var(--foreground);
}

.section-desc {
    color: var(--muted-foreground);
    font-size: 14px;
    margin: 0;
}

.info-box {
    background: var(--secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-bottom: 24px;
}

.info-box p {
    margin: 0;
    font-size: 14px;
    color: var(--foreground);
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

.info-box iconify-icon {
    color: var(--primary);
    font-size: 18px;
    margin-top: 2px;
    flex-shrink: 0;
}

.amount-display {
    text-align: center;
    padding: 24px;
    background: var(--background);
    border-radius: var(--radius-md);
    margin-bottom: 24px;
}

.amount-label {
    font-size: 14px;
    color: var(--muted-foreground);
    margin-bottom: 8px;
}

.amount-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--foreground);
}

.success-message {
    background: var(--success);
    color: var(--success-foreground);
    padding: 12px 16px;
    border-radius: var(--radius-md);
    margin-bottom: 16px;
    display: none;
    align-items: center;
    gap: 8px;
}

.error-message {
    background: var(--destructive);
    color: var(--destructive-foreground);
    padding: 12px 16px;
    border-radius: var(--radius-md);
    margin-bottom: 16px;
    display: none;
    align-items: center;
    gap: 8px;
}

.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.btn {
    flex: 1;
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: var(--primary);
    color: var(--primary-foreground);
}

.btn-primary:hover:not(:disabled) {
    opacity: 0.9;
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: var(--secondary);
    color: var(--secondary-foreground);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    background: var(--border);
}

#paystack-button {
    width: 100%;
    margin-top: 24px;
}
</style>
{% endblock %}

{% block brand_content %}
<div class="add-payment-container">
    <div class="card-panel">
        <div class="section-header">
            <h1 class="section-title">Add Payment Method</h1>
            <p class="section-desc">Enter your card details to save it for future payments</p>
        </div>

        <div class="info-box">
            <p>
                <iconify-icon icon="lucide:lock"></iconify-icon>
                <span>
                    Your card details are securely processed by Paystack. We never store your full card information. 
                    A minimal verification charge of {{ currency_symbol }}1.00 will be made to verify your card.
                </span>
            </p>
        </div>

        <div class="success-message" id="success-message">
            <iconify-icon icon="lucide:check-circle" style="font-size: 18px;"></iconify-icon>
            <span>Payment method added successfully! Redirecting...</span>
        </div>

        <div class="error-message" id="error-message">
            <iconify-icon icon="lucide:alert-circle" style="font-size: 18px;"></iconify-icon>
            <span id="error-text"></span>
        </div>

        <div class="amount-display">
            <div class="amount-label">Verification Amount</div>
            <div class="amount-value">{{ currency_symbol }}1.00</div>
            <div style="font-size: 12px; color: var(--muted-foreground); margin-top: 8px;">
                This minimal charge verifies your card and saves it for future use
            </div>
        </div>

        <div style="text-align: center;">
            <button id="paystack-button" class="btn btn-primary">
                <iconify-icon icon="lucide:credit-card"></iconify-icon>
                Enter Card Details
            </button>
        </div>

        <div class="form-actions">
            <a href="{% url 'brands:billing' %}" class="btn btn-secondary">
                <iconify-icon icon="lucide:x"></iconify-icon>
                Cancel
            </a>
        </div>
    </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const paystackButton = document.getElementById('paystack-button');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    
    paystackButton.addEventListener('click', function() {
        // Disable button
        paystackButton.disabled = true;
        paystackButton.innerHTML = '<iconify-icon icon="lucide:loader-2" style="animation: spin 1s linear infinite;"></iconify-icon> Processing...';
        
        // Hide previous messages
        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';
        
        // Initialize Paystack inline form
        const handler = PaystackPop.setup({
            key: '{{ paystack_public_key }}',
            email: '{{ user_email }}',
            amount: 100, // 1 unit in smallest currency unit (kobo/pesewa)
            currency: '{{ currency_code }}',
            ref: '{{ reference }}',
            metadata: {
                custom_fields: [
                    {
                        display_name: "Payment Type",
                        variable_name: "payment_type",
                        value: "Add Payment Method"
                    }
                ]
            },
            callback: function(response) {
                // Payment successful - save the authorization code
                fetch('{% url "brands:save_payment_method" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        authorization_code: response.authorization,
                        reference: response.reference
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status) {
                        successMessage.style.display = 'flex';
                        setTimeout(() => {
                            window.location.href = '{% url "brands:billing" %}';
                        }, 2000);
                    } else {
                        errorText.textContent = data.message || 'Failed to save payment method';
                        errorMessage.style.display = 'flex';
                        paystackButton.disabled = false;
                        paystackButton.innerHTML = '<iconify-icon icon="lucide:credit-card"></iconify-icon> Enter Card Details';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    errorText.textContent = 'An error occurred. Please try again.';
                    errorMessage.style.display = 'flex';
                    paystackButton.disabled = false;
                    paystackButton.innerHTML = '<iconify-icon icon="lucide:credit-card"></iconify-icon> Enter Card Details';
                });
            },
            onClose: function() {
                // User closed the popup
                paystackButton.disabled = false;
                paystackButton.innerHTML = '<iconify-icon icon="lucide:credit-card"></iconify-icon> Enter Card Details';
            }
        });
        
        // Open Paystack inline form
        handler.openIframe();
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
